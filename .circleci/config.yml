version: 2.1

orbs:
  ms-teams-notifier: oktapodia/ms-teams-notifier@3.0.0

parameters:
  env:
    type: enum
    default: stage
    enum:
      - stage
      - dev

executors:
  python-executor:
    docker:
      - image: cimg/python:3.11
    environment:
      ENV: << pipeline.parameters.env >>

jobs:
  integration-tests:
    executor: python-executor
    parameters:
      env:
        type: enum
        default: stage
        enum:
          - stage
          - dev
    steps:
      - checkout

      - run:
          name: Set up Python environment and install dependencies
          command: |
            cd src/be
            python -m venv .venv
            . .venv/bin/activate
            pip install -r requirements.txt
            pip install allure-pytest

      - run:
          name: Run integration tests with pytest
          command: |
            cd src/be
            . .venv/bin/activate
            export ENV=<< parameters.env >>
            pytest tests/ --alluredir=allure-results

      - run:
          name: Generate Allure report
          command: |
            cd src/be
            # Install allure commandline if not installed
            if ! command -v allure &> /dev/null; then
              npm install -g allure-commandline --save-dev
            fi
            mkdir -p allure-report
            allure generate --single-file allure-results --clean -o allure-report

      - store_artifacts:
          path: src/be/allure-report
          destination: allure-html-report

      - ms-teams-notifier/ms-teams-notify:
          webhook-url: $TEAMS_WEBHOOK_URL
          message: |
            << pipeline.status >>
            âœ… BE Integrations Pytest run completed in << parameters.env >> environment.
            [View Allure Report](https://output.circle-artifacts.com/output/job/${CIRCLE_WORKFLOW_JOB_ID}/artifacts/0/allure-html-report/index.html)

workflows:
  version: 2

  nightly-integration-tests:
    triggers:
      - schedule:
          cron: "0 1 * * *"  # 1:00 AM UTC = 4:00 AM Moldova time
          filters:
            branches:
              only:
                - main
    jobs:
      - integration-tests:
          env: stage
          filters:
            branches:
              only:
                - main
